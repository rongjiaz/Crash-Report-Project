---
title: "Untitled"
output: html_document
---
# Load Packages
```{r}
library(dplyr)
library(tidyr)
library(knitr)
library(ggplot2)
```

# Read Data
```{r}
Non_Motorists <-read.csv("https://data.montgomerycountymd.gov/api/views/n7fk-dce5/rows.csv?accessType=DOWNLOAD")

Drivers <- read.csv('https://data.montgomerycountymd.gov/api/views/mmzv-x632/rows.csv?accessType=DOWNLOAD')

Incidents <- read.csv('https://data.montgomerycountymd.gov/api/views/bhju-22kf/rows.csv?accessType=DOWNLOAD')
```

# 按照Agency.Name和crash.Date.Time以天为单位统计单位时间内发生的事故车辆数
```{r}
Drivers$Crash.Date.Time <-substring(as.character(Drivers$Crash.Date.Time), 1, 10)
Drivers_1 <-Drivers %>% group_by(Agency.Name, Crash.Date.Time) %>% summarise(Drivers_Count = n())
```

# 按照Agency.Name和crash.Date.Time以天为单位统计单位时间内发生的事故车辆数
```{r}
Incidents$Crash.Date.Time <-substring(as.character(Incidents$Crash.Date.Time), 1, 10)
Incidents_1 <-Incidents %>% group_by(Agency.Name, Crash.Date.Time) %>% summarise(Incidents_Count = n())
```

# 将Drivers_1和Incidents_1合并在一起
```{r}
Drivers_Incidents <-merge(Drivers_1, Incidents_1, by.x = c("Agency.Name", "Crash.Date.Time"), by.y = c("Agency.Name", "Crash.Date.Time"))
```

# 将严重程度指标按照严重程度转化为数值变量，5表示非常严重，1表示无显著伤口
```{r}
Non_Motorists$Injury.Severity <-recode(Non_Motorists$Injury.Severity, "FATAL INJURY" = 5, "SUSPECTED SERIOUS INJURY" = 4, "POSSIBLE INJURY" = 3, "SUSPECTED MINOR INJURY" = 2, "NO APPARENT INJURY" = 1)
```

# 将天气按照天气的恶劣程度转化为数值变量，1表示天气好，能见度高，0表示天气恶劣，能见度低，其中异常值转化为-99，并从样本中剔除
```{r}
Non_Motorists$Weather <-
        recode(Non_Motorists$Weather, "BLOWING SNOW" = 0, "CLEAR" = 1, "CLOUDY" = 1, "FOGGY" = 0, "N/A" = -99, "OTHER" = -99, "RAINING" = 0, "SEVERE WINDS" = 0, "SLEET" = 0, "SNOW" = 0, "UNKNOWN" = -99, "WINTRY MIX" = 0)

Non_Motorists <- Non_Motorists[!Non_Motorists$Weather == -99, ]
```

# 将照明情况按照明亮与否转化为数值变量，1表示能见度高，0表示能见度低,未知数据转化为-99，并从样本中剔除
```{r}
Non_Motorists$Light <-recode(Non_Motorists$Light, "DARK -- UNKNOWN LIGHTING" = 0, "DARK LIGHTS ON" = 0, "DARK NO LIGHTS" = 0, "DAWN" = 0, "DAYLIGHT" = 1, "DUSK" = 0, "N/A" = -99, "OTHER" = -99, "UNKNOWN" = -99)

Non_Motorists <- Non_Motorists[!Non_Motorists$Light == -99, ]
```

# 将路面情况按照通畅程度转化为数值变量，1表示路况正常，0表示路况不正常，将异常变量转化为-99，并从样本中剔除
```{r}
Non_Motorists$Surface.Condition <-recode(Non_Motorists$Surface.Condition," " = -99,"DRY" = 1, "ICE" = 0, "N/A" = -99, "OTHER" = -99, "SLUSH" = 0, "SNOW" = 0, "UNKNOW" = -99, "WET" = 0)
Non_Motorists <-Non_Motorists[!Non_Motorists$Surface.Condition == -99, ]
```

# 将交通管制，按照是否存在管治设施转化为数值变量，1表示存在管制，0表示不存在管制，将异常变量转化为-99，并从样本中剔除
```{r}
Non_Motorists$Traffic.Control <-recode(Non_Motorists$Traffic.Control, "FLASHING TRAFFIC SIGNAL" = 1, "N/A" = -99, "NO CONTROLS" = 0, "OTHER" = -99, "PERSON" = 1, "RAILWAY CROSSING DEVICE" = 1, "SCHOOL ZONE SIGN DEVICE" = 1, "STOP SIGN" = 1, "TRAFFIC SIGNAL" = 1, "UNKNOWN" = -99, "WARNING SIGN" = 1, "YIELD SIGN" = 1)
Non_Motorists <- Non_Motorists[!Non_Motorists$Traffic.Control == -99, ]
```

```{r}
Non_Motorists$At.Fault <-recode(Non_Motorists$At.Fault,"No" = 0,"Unknown" = -99,"Yes" = 1)
Non_Motorists <- Non_Motorists[!Non_Motorists$At.Fault == -99, ]
```
# 将时间转化为年/月
```{r}
Non_Motorists$Crash.Date.Time <-substring(as.character(Non_Motorists$Crash.Date.Time), 1, 10)
```

# 将调整的数据汇总，并将空缺值剔除
```{r}
Non_Motorists_1 <-Non_Motorists %>% select(Agency.Name, Crash.Date.Time, Injury.Severity, Weather, Light, Surface.Condition, Traffic.Control, At.Fault)
```

# 将Non_Motorists数据与Drivers_Incidents数据集合并在一起
```{r}
Non_Motorists_1 <-
        merge(
                Non_Motorists_1,
                Drivers_Incidents,
                by.x = c("Agency.Name", "Crash.Date.Time"),
                by.y = c("Agency.Name", "Crash.Date.Time")
        )
Data <-    na.omit(Non_Motorists_1)
```

```{r}
View(Data)
```

# Exploratory Data Analysis
# 目前数据集Data中共存在10个变量，其中Injury.Severity, Weather, Light, Surface.Condition, Traffic.Control, At.Fault属于categorical
# Drivers_Count, Incidents_Count属于quantitative
# 第一步探索性数据分析，首先对categorical做Frequency counts

# 对Weather做Frequency counts，0表示天气恶劣，1表示天气好
```{r}
Data %>% 
        count(Weather) %>% 
        mutate(prop = prop.table(n))
```

# 对Light做Frequency counts，1表示能见度高，0表示能见度低好
```{r}
Data %>% 
        count(Light) %>% 
        mutate(prop = prop.table(n))
```
# 对Surface.Condition做Frequency counts, 1表示路况正常，0表示路况不正常
```{r}
Data %>% 
        count(Surface.Condition) %>% 
        mutate(prop = prop.table(n))
```
# 对Traffic.Control做Frequency counts, 1表示存在管制，0表示不存在管制
```{r}
Data %>% 
        count(Traffic.Control) %>% 
        mutate(prop = prop.table(n))
```
# 对At.Fault做Frequency counts, 1表示有过错，0表示无过错
```{r}
Data %>% 
        count(At.Fault) %>% 
        mutate(prop = prop.table(n))
```
# 最后对Injury.Severity做Frequency counts, 5表示非常严重，1表示无显著伤口
```{r}
Data %>% 
        count(Injury.Severity) %>% 
        mutate(prop = prop.table(n))
```
# 为了研究受伤程度与categorical的关系，做contingency table
```{r}
Data %>% 
        group_by(Injury.Severity, Weather) %>% 
        summarize(n = n()) %>% 
        spread(Weather, n) %>%
        kable()
```
```{r}
Data %>% 
        group_by(Injury.Severity, Light) %>% 
        summarize(n = n()) %>% 
        spread(Light, n) %>%
        kable()
```
```{r}
Data %>% 
        group_by(Injury.Severity, Surface.Condition) %>% 
        summarize(n = n()) %>% 
        spread(Surface.Condition, n) %>%
        kable()
```
```{r}
Data %>% 
        group_by(Injury.Severity, Traffic.Control) %>% 
        summarize(n = n()) %>% 
        spread(Traffic.Control, n) %>%
        kable()
```

```{r}
Data %>% 
        group_by(Injury.Severity, At.Fault) %>% 
        summarize(n = n()) %>% 
        spread(At.Fault, n) %>%
        kable()
```

# 对属于quantitative的变量做描述性统计, 分别统计两个数值型变量的平均值，最大值，最小值，标准差

```{r}
Data %>% 
        select(Drivers_Count, Incidents_Count) %>%
        summarise(n = n(), Drivers_Count_average = mean(Drivers_Count), Incidents_Count_average = mean(Incidents_Count),
                  Drivers_Count_max = max(Drivers_Count), Incidents_Count_max = max(Incidents_Count),
                  Drivers_Count_min = min(Drivers_Count), Incidents_Count_min = min(Incidents_Count),
                  Drivers_Count_sd = sd(Drivers_Count), Incidents_Count_sd = sd(Incidents_Count)) 
```
# 通过箱型图观察事故发生数的Injury.Severity分布
```{r}
ggplot(Data, aes(x = factor(Injury.Severity, labels = c("NO INJURY","MINOR INJURY","POSSIBLE INJURY", "SERIOUS INJURY","FATAL INJURY")), y = Drivers_Count)) +
        geom_boxplot(varwidth=TRUE, fill="plum") +
        labs(title="Distribution of drivers count for days by injury severity",
             caption="data.montgomerycountymd.gov",
             x="Injury Severity",
             y="Drivers Count")
```
# 通过箱型图观察事故发生数的Injury.Severit分布在不同能见度水平下
```{r}
Data$Visibility <- factor(Data$Light,labels=c("Bad","Good"))
ggplot(Data, aes(x = factor(Injury.Severity, labels = c("NO INJURY","MINOR INJURY","POSSIBLE INJURY",
        "SERIOUS INJURY","FATAL INJURY")), y = Drivers_Count, fill=Visibility )) +
        geom_boxplot(varwidth=TRUE) +
        labs(title="Distribution of drivers count for days by injury severity",
             caption="data.montgomerycountymd.gov",
             x="Injury Severity",
             y="Drivers Count")
```
# 通过箱型图观察事故发生数的Injury.Severity分布在不同天气水平下
```{r}
Data$Climate <- factor(Data$Weather,labels=c("Bad Weather","Good Weather"))
ggplot(Data, aes(x = factor(Injury.Severity, labels = c("NO INJURY","MINOR INJURY","POSSIBLE INJURY",
                                                        "SERIOUS","FATAL")), y = Drivers_Count,
                 fill=Climate )) +
        geom_boxplot(varwidth=TRUE) +
        labs(title="Distribution of drivers count for days by injury severity",
             caption="data.montgomerycountymd.gov",
             x="Injury Severity",
             y="Drivers Count")
```
# Statistical Analysis
# 利用卡方检验，判断Injury.Severity和categorical变量间的差异性
```{r}
fisher.test(Data$Injury.Severity,Data$Weather)
chisq.test(Data$Injury.Severity,Data$Light)
chisq.test(Data$Injury.Severity,Data$Surface.Condition)
chisq.test(Data$Injury.Severity,Data$Traffic.Control)
chisq.test(Data$Injury.Severity,Data$At.Fault)
```
# 使用点估计判断，双侧检验判断事故车辆发生数是否与1无异，点估计是一种假设检验，
# 原假设事故车辆与1是无显著差异的，在给定显著性水平，事故车辆与1是有显著差异的
```{r}
t.test(Data$Drivers_Count == 1)
t.test(Data$Incidents_Count == 1)
```
# 先判断事故车辆数是否具有正态性，原假设是事故车辆数量属于正态分布，在给定显著性水平
# 拒绝原假设说明事故车辆不符合正态分布
```{r}
shapiro.test(Data$Drivers_Count)
```
# 根据结果事故车辆数是不符合正态性，所以我们用非参数检验Wilcoxon rank sum test
# 秩和检验，原假设为车辆事故数与受伤害程度之间不存在显著差异，如果在给定显著性水平
# 拒绝原假设说明存在显著差异
```{r}
wilcox.test(Data$Drivers_Count,Data$Injury.Severity,alternative="two.sided",exact=FALSE,correct=TRUE)
```
# 先判断事故数是否具有正态性
```{r}
shapiro.test(Data$Incidents_Count)
wilcox.test(Data$Incidents_Count,Data$Injury.Severity,alternative="two.sided",exact=FALSE,correct=TRUE)
```
# 构建多元回归，预测事故伤残程度的线性回归
```{r}
lm.mol <- lm(Injury.Severity~Weather+Light+Surface.Condition+Traffic.Control+At.Fault+Drivers_Count+Incidents_Count, data =Data)
summary(lm.mol)
```


# Visualization

# 通过折线图，观察不同时间不同机构不同受伤程度以及不同天气下的事故发生数
```{r}
s1 <- Data%>%group_by(Agency.Name,Injury.Severity, strftime(strptime(Crash.Date.Time,'%m/%d/%Y'),'%m'))%>%summarise(n=n())
colnames(s1) = c("agency_name", "Severity","time", "n")

ggplot(s1, aes(time, n)) +
        geom_point(aes(colour = agency_name)) +
        facet_grid(factor(Severity, labels = c("NO INJURY","MINOR ","POSSIBLE ",
                                                      "SERIOUS ","FATAL"))~.) +
        labs(x="Month", y ="Non-motorised injuries",
             title = "Trend analysis of the number of injuries")

```

```{r}
# 通过折线图，观察不同时间不同机构不同受伤程度以及不同天气下的事故发生数
s1 <- Data%>%group_by(Agency.Name,Injury.Severity,Surface.Condition, strftime(strptime(Crash.Date.Time,'%m/%d/%Y'),'%Y'))%>%summarise(n=n())
colnames(s1) = c("agency_name", "Severity","Surface","time", "n")

ggplot(s1, aes(time, n)) +
        geom_point(aes(colour = agency_name)) +
        facet_grid(factor(Surface, labels = c('BAD','GOOD'))~factor(Severity, labels = c("NO INJURY","MINOR ","POSSIBLE ",
                                                                                         "SERIOUS ","FATAL"))) +
        labs(x="Year", y ="Non-motorised injuries",
             title = "Trend analysis of the number of injuries by Surface Condition")

```











































